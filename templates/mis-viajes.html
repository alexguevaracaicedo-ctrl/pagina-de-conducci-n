<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Viajes - Transporte Águila S.A.S.</title>
    <link href="{{ url_for('static', filename='css/transporte-mejorado.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/area-usuario.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mis-viajes.css') }}" rel="stylesheet">
</head>

<body>
    <div class="patron-fondo"></div>

    <!-- Área de usuario -->
    <div class="area-usuario" id="area-usuario">
        <div class="avatar-usuario" id="avatar-usuario">
            <span id="iniciales-usuario">US</span>
        </div>
        <div class="info-usuario">
            <span class="nombre-usuario" id="nombre-display">Cargando...</span>
            <span class="saludo-usuario" id="saludo-usuario">¡Bienvenido!</span>
        </div>

        <div class="menu-usuario">
            <div class="opcion-menu" onclick="window.location.href='/perfil'">
                <span class="icono-menu">👤</span>
                <span>Mi Perfil</span>
            </div>
            <div class="opcion-menu" onclick="window.location.href='/mis-viajes'">
                <span class="icono-menu">📋</span>
                <span>Mis Viajes</span>
            </div>
            <div class="opcion-menu" onclick="cerrarSesion()">
                <span class="icono-menu">🚪</span>
                <span>Cerrar Sesión</span>
            </div>
        </div>
    </div>

    <!-- Navegación -->
    <nav class="barra-navegacion">
        <div class="contenido-nav">
            <div class="logotipo">
                <div class="icono-logo">🦅</div>
                <span>Águila</span>
            </div>

            <ul class="enlaces-nav" id="enlaces-nav">
                <li><a href="/dashboard" class="enlace-nav activo">Inicio</a></li>
                <li><a href="/nosotros" class="enlace-nav">Nosotros</a></li>
                <li><a href="/servicios" class="enlace-nav">Servicios</a></li>
                <li><a href="/rutas" class="enlace-nav">Rutas</a></li>
                <li><a href="/reservar" class="enlace-nav">Reservar</a></li>
            </ul>

            <button class="boton-menu" id="boton-menu">☰</button>
        </div>
    </nav>

    <!-- Main -->
    <main class="contenido-principal">
        <h1 class="titulo-principal">Mis Viajes</h1>
        <div class="grilla-viajes" id="grilla-viajes">
            <!-- Las tarjetas de viajes se generan aquí -->
        </div>
        <div class="mensaje-vacio" id="mensaje-vacio" style="display: none;">
            <h3>No tienes viajes</h3>
            <p>Aún no has reservado ningún viaje.</p>
        </div>
    </main>

    <footer>
        <div class="contenedor">
            <p>&copy; 2024 Transporte Águila S.A.S. - Conectando el Chocó con seguridad y confianza</p>
        </div>
    </footer>

    <script>


        document.getElementById('boton-menu').addEventListener('click', function () {
            document.getElementById('enlaces-nav').classList.toggle('activo');
        });

        async function obtenerViajes() {
            try {
                const res = await fetch('/api/mis-solicitudes');
                const data = await res.json();
                const grilla = document.getElementById('grilla-viajes');
                const mensaje = document.getElementById('mensaje-vacio');

                grilla.innerHTML = '';

                if (data.success && data.solicitudes && data.solicitudes.length > 0) {
                    mensaje.style.display = 'none';

                    data.solicitudes.forEach(solicitud => {
                        const tarjeta = document.createElement('div');
                        tarjeta.className = 'tarjeta-viaje aparecer';


                        const estadoClasses = {
                            'pendiente': 'estado-pendiente',
                            'aceptada': 'estado-aceptada',
                            'en_curso': 'estado-en-curso',
                            'completada': 'estado-completada',
                            'cancelada': 'estado-cancelada'
                        };

                        const estadoTextos = {
                            'pendiente': '⏳ Pendiente',
                            'aceptada': '✅ Aceptada',
                            'en_curso': '🚗 En Curso',
                            'completada': '✔️ Completada',
                            'cancelada': '❌ Cancelada'
                        };

                        const fecha = new Date(solicitud.fecha_servicio);
                        const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        const conductorHTML = solicitud.conductor ? `
                    <div class="info-conductor">
                        <strong>Conductor:</strong> ${solicitud.conductor.nombre}<br>
                        <strong>Teléfono:</strong> ${solicitud.conductor.telefono}
                    </div>
                ` : '';

                        tarjeta.innerHTML = `
                    <div class="encabezado-viaje">
                        <div class="codigo-viaje">#${solicitud.codigo_solicitud}</div>
                        <div class="estado-viaje ${estadoClasses[solicitud.estado] || ''}">
                            ${estadoTextos[solicitud.estado] || solicitud.estado}
                        </div>
                    </div>
                    
                    <div class="tipo-vehiculo-badge">
                        ${obtenerIconoVehiculo(solicitud.tipo_vehiculo)} ${solicitud.tipo_vehiculo.toUpperCase()}
                    </div>
                    
                    <div class="ruta-viaje">
                        <div class="punto-inicio">
                            <span class="icono-punto">📍</span>
                            <span>${solicitud.origen}</span>
                        </div>
                        <div class="linea-ruta">→</div>
                        <div class="punto-final">
                            <span class="icono-punto">🎯</span>
                            <span>${solicitud.destino}</span>
                        </div>
                    </div>
                    
                    <div class="detalles-viaje">
                        <div class="detalle-item">
                            <span class="icono-detalle">📅</span>
                            <span>${fechaFormateada}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="icono-detalle">⏰</span>
                            <span>${solicitud.hora_servicio}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="icono-detalle">👥</span>
                            <span>${solicitud.numero_pasajeros} pasajero${solicitud.numero_pasajeros > 1 ? 's' : ''}</span>
                        </div>
                        <div class="detalle-item precio">
                            <span class="icono-detalle">💰</span>
                            <span>${solicitud.precio_final ? '$' + solicitud.precio_final.toLocaleString() : '$' + solicitud.precio_estimado.toLocaleString() + ' (estimado)'}</span>
                        </div>
                    </div>
                    
                    ${conductorHTML}
                    
                    ${solicitud.observaciones ? `
                        <div class="observaciones-viaje">
                            <strong>Observaciones:</strong> ${solicitud.observaciones}
                        </div>
                    ` : ''}
                `;

                        grilla.appendChild(tarjeta);
                    });
                } else {
                    mensaje.style.display = 'block';
                }
            } catch (error) {
                console.error('Error cargando viajes:', error);
                document.getElementById('mensaje-vacio').innerHTML = `
            <h3>Error al cargar viajes</h3>
            <p>Por favor, intenta nuevamente más tarde.</p>
        `;
                document.getElementById('mensaje-vacio').style.display = 'block';
            }
        }

        function obtenerIconoVehiculo(tipo) {
            const iconos = {
                'moto': '🏍️',
                'carro': '🚗',
                'bus': '🚌',
                '4x4': '🚙'
            };
            return iconos[tipo] || '🚗';
        }


        async function configurarAreaUsuario() {
            try {
                const response = await fetch('/api/usuario');
                const data = await response.json();

                if (data.success) {
                    const usuario = data.usuario;
                    const iniciales = `${usuario.nombre.charAt(0)}${usuario.apellido.charAt(0)}`.toUpperCase();
                    const color = generarColor(usuario.nombre + usuario.apellido);

                    document.getElementById('iniciales-usuario').textContent = iniciales;
                    document.getElementById('nombre-display').textContent = `${usuario.nombre} ${usuario.apellido}`;
                    document.getElementById('avatar-usuario').style.background = `linear-gradient(135deg, ${color}, ${color}dd)`;

                    const hora = new Date().getHours();
                    let saludo = '¡Bienvenido!';
                    if (hora < 12) saludo = '¡Buenos días!';
                    else if (hora < 18) saludo = '¡Buenas tardes!';
                    else saludo = '¡Buenas noches!';
                    document.getElementById('saludo-usuario').textContent = saludo;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function generarColor(texto) {
            const colores = ['#6366f1', '#4f46e5', '#8b5cf6', '#06b6d4', '#22c55e', '#f59e0b', '#ef4444'];
            let hash = 0;
            for (let i = 0; i < texto.length; i++) {
                hash = texto.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colores[Math.abs(hash) % colores.length];
        }

        async function cerrarSesion() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    window.location.href = '/login';
                }
            }
        }


        document.addEventListener('DOMContentLoaded', function () {
            configurarAreaUsuario();
            obtenerViajes();
        });
    </script>
</body>

</html>