<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Viajes - Transporte √Åguila S.A.S.</title>
    <link href="{{ url_for('static', filename='css/transporte-mejorado.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/area-usuario.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mis-viajes.css') }}" rel="stylesheet">
</head>

<body>
    <div class="patron-fondo"></div>

    <!-- √Årea de usuario -->
    <div class="area-usuario" id="area-usuario">
        <div class="avatar-usuario" id="avatar-usuario">
            <span id="iniciales-usuario">US</span>
        </div>
        <div class="info-usuario">
            <span class="nombre-usuario" id="nombre-display">Cargando...</span>
            <span class="saludo-usuario" id="saludo-usuario">¬°Bienvenido!</span>
        </div>

        <div class="menu-usuario">
            <div class="opcion-menu" onclick="window.location.href='/perfil'">
                <span class="icono-menu">üë§</span>
                <span>Mi Perfil</span>
            </div>
            <div class="opcion-menu" onclick="window.location.href='/mis-viajes'">
                <span class="icono-menu">üìã</span>
                <span>Mis Viajes</span>
            </div>
            <div class="opcion-menu" onclick="cerrarSesion()">
                <span class="icono-menu">üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n -->
    <nav class="barra-navegacion">
        <div class="contenido-nav">
            <div class="logotipo">
                <div class="icono-logo">ü¶Ö</div>
                <span>√Åguila</span>
            </div>

            <ul class="enlaces-nav" id="enlaces-nav">
                <li><a href="/dashboard" class="enlace-nav">Inicio</a></li>
                <li><a href="/nosotros" class="enlace-nav">Nosotros</a></li>
                <li><a href="/servicios" class="enlace-nav">Servicios</a></li>
                <li><a href="/rutas" class="enlace-nav">Rutas</a></li>
                <li><a href="/reservar" class="enlace-nav">Reservar</a></li>
            </ul>

            <button class="boton-menu" id="boton-menu">‚ò∞</button>
        </div>
    </nav>

    <!-- Main -->
    <main class="contenido-principal">
        <h1 class="titulo-principal">Mis Viajes</h1>

        <!-- Tabs para Solicitudes y Reservas -->
        <div class="tabs-viajes">
            <button class="tab-btn activo" onclick="cambiarTab('solicitudes')">
                üöó Servicios Solicitados
            </button>
            <button class="tab-btn" onclick="cambiarTab('reservas')">
                üé´ Reservas de Horarios
            </button>
            <button class="tab-btn" onclick="cambiarTab('todos')">
                üìã Todos
            </button>
        </div>

        <!-- Filtros por estado -->
        <div class="filtros-estado">
            <button class="filtro-btn activo" data-filtro="todas">Todas</button>
            <button class="filtro-btn" data-filtro="pendiente">Pendientes</button>
            <button class="filtro-btn" data-filtro="aceptada,confirmada">Confirmadas</button>
            <button class="filtro-btn" data-filtro="completada,pagada">Completadas</button>
            <button class="filtro-btn" data-filtro="cancelada">Canceladas</button>
        </div>

        <div class="grilla-viajes" id="grilla-viajes">
            <div class="mensaje-cargando">
                <div class="spinner"></div>
                <p>Cargando viajes...</p>
            </div>
        </div>

        <div class="mensaje-vacio" id="mensaje-vacio" style="display: none;">
            <h3>No tienes viajes</h3>
            <p>A√∫n no has solicitado servicios ni hecho reservas.</p>
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 20px;">
                <button class="boton boton-primario" onclick="window.location.href='/servicios'">
                    Solicitar Servicio
                </button>
                <button class="boton boton-secundario" onclick="window.location.href='/reservar'">
                    Hacer Reserva
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div class="contenedor">
            <p>&copy; 2024 Transporte √Åguila S.A.S. - Conectando el Choc√≥ con seguridad y confianza</p>
        </div>
    </footer>

    <!-- Chat Widget se agregar√° aqu√≠ -->

    <script>
        let todasLasSolicitudes = [];
        let todasLasReservas = [];
        let todosLosViajes = [];
        let tabActual = 'solicitudes';
        let filtroActual = 'todas';

        document.getElementById('boton-menu').addEventListener('click', function () {
            document.getElementById('enlaces-nav').classList.toggle('activo');
        });

        async function configurarAreaUsuario() {
            try {
                const response = await fetch('/api/usuario');
                const data = await response.json();

                if (data.success) {
                    const usuario = data.usuario;
                    const iniciales = `${usuario.nombre.charAt(0)}${usuario.apellido.charAt(0)}`.toUpperCase();
                    const color = generarColor(usuario.nombre + usuario.apellido);

                    document.getElementById('iniciales-usuario').textContent = iniciales;
                    document.getElementById('nombre-display').textContent = `${usuario.nombre} ${usuario.apellido}`;
                    document.getElementById('avatar-usuario').style.background = `linear-gradient(135deg, ${color}, ${color}dd)`;

                    const hora = new Date().getHours();
                    let saludo = '¬°Bienvenido!';
                    if (hora < 12) saludo = '¬°Buenos d√≠as!';
                    else if (hora < 18) saludo = '¬°Buenas tardes!';
                    else saludo = '¬°Buenas noches!';
                    document.getElementById('saludo-usuario').textContent = saludo;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarTodosLosViajes() {
            try {
                // Cargar solicitudes de servicio
                const solicitudesResp = await fetch('/api/mis-solicitudes');
                const solicitudesData = await solicitudesResp.json();

                // Cargar reservas de horarios
                const reservasResp = await fetch('/api/mis-reservas');
                const reservasData = await reservasResp.json();

                const grilla = document.getElementById('grilla-viajes');
                const mensaje = document.getElementById('mensaje-vacio');

                if (solicitudesData.success) {
                    todasLasSolicitudes = solicitudesData.solicitudes || [];
                }

                if (reservasData.success) {
                    todasLasReservas = reservasData.reservas || [];
                }

                // Combinar y ordenar por fecha
                todosLosViajes = [
                    ...todasLasSolicitudes.map(s => ({ ...s, tipo: 'solicitud' })),
                    ...todasLasReservas.map(r => ({ ...r, tipo: 'reserva' }))
                ].sort((a, b) => {
                    const fechaA = new Date(a.fecha_solicitud || a.fecha_reserva);
                    const fechaB = new Date(b.fecha_solicitud || b.fecha_reserva);
                    return fechaB - fechaA;
                });

                if (todosLosViajes.length === 0) {
                    grilla.innerHTML = '';
                    mensaje.style.display = 'block';
                } else {
                    mensaje.style.display = 'none';
                    aplicarFiltros();
                }
            } catch (error) {
                console.error('Error cargando viajes:', error);
                document.getElementById('grilla-viajes').innerHTML = `
                    <div class="mensaje-error">
                        <h3>Error al cargar viajes</h3>
                        <p>Por favor, intenta nuevamente m√°s tarde.</p>
                    </div>
                `;
            }
        }

        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('activo'));
            event.target.classList.add('activo');
            aplicarFiltros();
        }

        function aplicarFiltros() {
            let viajesFiltrados = todosLosViajes;

            // Filtrar por tab
            if (tabActual === 'solicitudes') {
                viajesFiltrados = viajesFiltrados.filter(v => v.tipo === 'solicitud');
            } else if (tabActual === 'reservas') {
                viajesFiltrados = viajesFiltrados.filter(v => v.tipo === 'reserva');
            }

            // Filtrar por estado
            if (filtroActual !== 'todas') {
                const estados = filtroActual.split(',');
                viajesFiltrados = viajesFiltrados.filter(v => estados.includes(v.estado));
            }

            mostrarViajes(viajesFiltrados);
        }

        function mostrarViajes(viajes) {
            const grilla = document.getElementById('grilla-viajes');
            grilla.innerHTML = '';

            if (viajes.length === 0) {
                grilla.innerHTML = `
                    <div class="mensaje-vacio">
                        <div class="icono-vacio">üî≠</div>
                        <h3>No hay viajes en esta categor√≠a</h3>
                        <p>Prueba con otros filtros</p>
                    </div>
                `;
                return;
            }

            viajes.forEach(viaje => {
                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-viaje aparecer';

                if (viaje.tipo === 'solicitud') {
                    tarjeta.innerHTML = crearTarjetaSolicitud(viaje);
                } else {
                    tarjeta.innerHTML = crearTarjetaReserva(viaje);
                }

                grilla.appendChild(tarjeta);
            });
        }

        function crearTarjetaSolicitud(solicitud) {
            const estadoClasses = {
                'pendiente': 'estado-pendiente',
                'aceptada': 'estado-aceptada',
                'en_curso': 'estado-en-curso',
                'completada': 'estado-completada',
                'cancelada': 'estado-cancelada'
            };

            const estadoTextos = {
                'pendiente': '‚è≥ Buscando Conductor',
                'aceptada': '‚úÖ Conductor Asignado',
                'en_curso': 'üöó En Curso',
                'completada': '‚úîÔ∏è Completada',
                'cancelada': '‚ùå Cancelada'
            };

            const fecha = new Date(solicitud.fecha_servicio);
            const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const conductorHTML = solicitud.conductor ? `
                <div class="info-conductor">
                    <strong>üöó Conductor:</strong> ${solicitud.conductor.nombre}<br>
                    <strong>üìû Tel√©fono:</strong> ${solicitud.conductor.telefono}
                </div>
            ` : '';

            return `
                <div class="badge-tipo">üöó Servicio Solicitado</div>
                <div class="encabezado-viaje">
                    <div class="codigo-viaje">#${solicitud.codigo_solicitud}</div>
                    <div class="estado-viaje ${estadoClasses[solicitud.estado] || ''}">
                        ${estadoTextos[solicitud.estado] || solicitud.estado}
                    </div>
                </div>
                
                <div class="tipo-vehiculo-badge">
                    ${obtenerIconoVehiculo(solicitud.tipo_vehiculo)} ${solicitud.tipo_vehiculo.toUpperCase()}
                </div>
                
                <div class="ruta-viaje">
                    <div class="punto-inicio">
                        <span class="icono-punto">üìç</span>
                        <span>${solicitud.origen}</span>
                    </div>
                    <div class="linea-ruta">‚Üí</div>
                    <div class="punto-final">
                        <span class="icono-punto">üéØ</span>
                        <span>${solicitud.destino}</span>
                    </div>
                </div>
                
                <div class="detalles-viaje">
                    <div class="detalle-item">
                        <span class="icono-detalle">üìÖ</span>
                        <span>${fechaFormateada}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="icono-detalle">‚è∞</span>
                        <span>${solicitud.hora_servicio}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="icono-detalle">üë•</span>
                        <span>${solicitud.numero_pasajeros} pasajero${solicitud.numero_pasajeros > 1 ? 's' : ''}</span>
                    </div>
                    <div class="detalle-item precio">
                        <span class="icono-detalle">üí∞</span>
                        <span>${solicitud.precio_final ? '$' + solicitud.precio_final.toLocaleString() : '$' + solicitud.precio_estimado.toLocaleString() + ' (estimado)'}</span>
                    </div>
                </div>
                
                ${conductorHTML}
                
                ${solicitud.observaciones ? `
                    <div class="observaciones-viaje">
                        <strong>üìù Observaciones:</strong> ${solicitud.observaciones}
                    </div>
                ` : ''}
            `;
        }

        function crearTarjetaReserva(reserva) {
            const estadoClasses = {
                'pendiente': 'estado-pendiente',
                'confirmada': 'estado-aceptada',
                'pagada': 'estado-completada',
                'cancelada': 'estado-cancelada'
            };

            const estadoTextos = {
                'pendiente': '‚è≥ Pendiente de Pago',
                'confirmada': '‚úÖ Confirmada',
                'pagada': 'üí≥ Pagada',
                'cancelada': '‚ùå Cancelada'
            };

            const fechaSalida = new Date(reserva.fecha_salida);
            const fechaFormateada = fechaSalida.toLocaleDateString('es-CO', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return `
                <div class="badge-tipo">üé´ Reserva de Horario</div>
                <div class="encabezado-viaje">
                    <div class="codigo-viaje">${reserva.codigo_reserva}</div>
                    <div class="estado-viaje ${estadoClasses[reserva.estado] || ''}">
                        ${estadoTextos[reserva.estado] || reserva.estado}
                    </div>
                </div>
                
                <div class="tipo-vehiculo-badge">
                    ${obtenerIconoVehiculo(reserva.tipo_vehiculo)} ${reserva.tipo_vehiculo.toUpperCase()}
                </div>
                
                <div class="ruta-viaje">
                    <div class="punto-inicio">
                        <span class="icono-punto">üìç</span>
                        <span>${reserva.origen}</span>
                    </div>
                    <div class="linea-ruta">‚Üí</div>
                    <div class="punto-final">
                        <span class="icono-punto">üéØ</span>
                        <span>${reserva.destino}</span>
                    </div>
                </div>
                
                <div class="detalles-viaje">
                    <div class="detalle-item">
                        <span class="icono-detalle">üìÖ</span>
                        <span>${fechaFormateada}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="icono-detalle">‚è∞</span>
                        <span>${fechaSalida.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="icono-detalle">üë§</span>
                        <span>${reserva.nombre_pasajero}</span>
                    </div>
                    <div class="detalle-item precio">
                        <span class="icono-detalle">üí∞</span>
                        <span>$${reserva.precio_total.toLocaleString()}</span>
                    </div>
                </div>
                
                ${reserva.placa ? `
                    <div class="info-conductor">
                        <strong>üöå Veh√≠culo:</strong> ${reserva.placa}
                    </div>
                ` : ''}
                
                ${reserva.estado === 'pendiente' ? `
                    <div class="acciones-viaje">
                        <button class="boton boton-primario" onclick="confirmarPagoReserva('${reserva.codigo_reserva}')">
                            Confirmar Pago
                        </button>
                        <button class="boton boton-secundario" onclick="cancelarReserva('${reserva.codigo_reserva}')">
                            Cancelar
                        </button>
                    </div>
                ` : ''}
            `;
        }

        function obtenerIconoVehiculo(tipo) {
            const iconos = {
                'moto': 'üèçÔ∏è',
                'carro': 'üöó',
                'bus': 'üöå',
                '4x4': 'üöô'
            };
            return iconos[tipo] || 'üöó';
        }

        function confirmarPagoReserva(codigo) {
            if (confirm('¬øDeseas confirmar el pago de esta reserva?')) {
                alert('Funcionalidad de pago - Pr√≥ximamente\n\nC√≥digo: ' + codigo);
            }
        }

        function cancelarReserva(codigo) {
            if (confirm('¬øEst√°s seguro de que deseas cancelar esta reserva?')) {
                alert('Funcionalidad de cancelaci√≥n - Pr√≥ximamente\n\nC√≥digo: ' + codigo);
            }
        }

        // Filtros de estado
        document.querySelectorAll('.filtro-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('activo'));
                this.classList.add('activo');
                filtroActual = this.dataset.filtro;
                aplicarFiltros();
            });
        });

        function generarColor(texto) {
            const colores = ['#6366f1', '#4f46e5', '#8b5cf6', '#06b6d4', '#22c55e', '#f59e0b', '#ef4444'];
            let hash = 0;
            for (let i = 0; i < texto.length; i++) {
                hash = texto.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colores[Math.abs(hash) % colores.length];
        }

        async function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    window.location.href = '/login';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            configurarAreaUsuario();
            cargarTodosLosViajes();
        });
    </script>


</body>

</html>